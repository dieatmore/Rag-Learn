# RAG-检索增强生成

## 📝 OVERVIEW

RAG的学习记录：了解RAG，测试并完成一个RAG的使用。

### 🛠️ Development Tools

- spring-boot
- spring-ai
- qdrant 向量数据库

### 🤖 MODEL

选用阿里text-embedding-v4向量模型，1024维度。

<hr/>

###  ❓ Testings


1. `如何添加用户？`

   + 管理员可以通过该模块添加新用户, score: 0.8232988119125366
   + 管理员功能模块，添加用户功能, score: 0.6546160578727722
   + 管理员功能模块，更改用户权限, score: 0.5420510768890381
   + 你好，世界, score: 0.29887068271636963

> + <font size="3">管理员可以通过该模块添加新用户：文本语义与检索词完全贴合</font>
> + <font size="3">管理员功能模块，添加用户功能：语义仍关联 “添加用户”，但贴合度略低，侧重“功能”，文本冗余 / 碎片化，语义被稀释</font>
> + <font size="3">管理员功能模块，更改用户权限：核心动作偏离，但业务场景仍关联</font>
> + <font size="3">你好，世界：与检索词无任何语义关联，得分接近 0.3，仅代表 “向量空间中无意义的基础相似度”（所有文本向量与任意检索词向量都会有极低的默认相似度），无实际业务意义。</font>

2. `苹果 手机`

   + Apple手机, score: 0.8166669607162476
   + 苹果手机, score: 0.8148566484451294 
   
     > <font size="3">得分略低的原因：仅因嵌入模型对中英文品牌词编码的极细微差异（无业务层面的区别），整体仍属于 “核心匹配” 范畴。</font>
   + 苹果正品手机, score: 0.8065965175628662

     > <font size="3">"正品" 冗余修饰词稀释核心语义</font>
   + iPhone手机, score: 0.7403218746185303

     > <font size="3">语义范围缩小，“iPhone” 是苹果品牌下的具体产品系列（而非品牌本身）</font>
   + 华为手机, score: 0.6459783315658569
   + OPPO手机, score: 0.6293975710868835
   + 小米手机, score: 0.6134622097015381
   + iPhone 16 Pro Max 旗舰新品, score: 0.47404536604881287

     > <font size="3">大量冗余信息严重稀释核心语义,关键词仅占语义的一部分，冗余信息会彻底拉低匹配度</font>
   + 你好，世界, score: 0.40358448028564453
   

### ✅ DETAIL

##### 一、比赛目录 Test
+ 三个等级比赛目录，一个等级一段（第三等级一段有五十多个比赛）
  + 1. "全国大学生软件创新大赛"
       + 第三等级score: 0.6248294115066528
       + 第二等级score: 0.594414234161377  <font size="3">（正确）</font>
       + 第一等级score: 0.5264873504638672
  + 2. "全国大学生工业设计大赛"
       + 第三等级score: 0.6173943877220154  <font size="3">（正确） </font>
       + 第二等级score: 0.5832704305648804
       + 第一等级score: 0.5033977031707764
  + 3. "蓝桥杯是什么比赛"
       + 第三等级score: 0.497569739818573 <font size="3"> （正确） </font>
       + 第二等级score: 0.47684207558631897
       + 第三等级score: 0.4593309164047241
       
<br/>     
<br/>     

+ 三个等级比赛目录，7~8个比赛一段（第三等级有8段）
  + 1. "全国大学生软件创新大赛"
       + 第二等级(某段)score: 0.6226876378059387 <font size="3"> （正确） </font>
       + 第三等级(某段)score: 0.6088396310806274
       + 第三等级(某段)score: 0.594118595123291
  + 2. "全国大学生工业设计大赛"
       + 第三等级(某段)score: 0.6241661310195923
       + 第三等级(某段)score: 0.6048571467399597
       + 第二等级(某段)score: 0.5808905959129333
       + 第三等级(某段)score: 0.5807852149009705 <font size="3"> （正确） </font>
  + 3. "蓝桥杯是什么比赛"
       + 第三等级(某段)score: 0.5459176301956177
       + 第三等级(某段)score: 0.5451034307479858 <font size="3"> （正确） </font>
       + 第三等级(某段)score: 0.5154807567596436
  + 4. "全国大学生工业设计大赛是什么比赛？"
       + 第三等级(某段)score: 0.6899532079696655
       + 第三等级(某段)score: 0.6692834496498108
       + 第三等级(某段)score: 0.650834321975708 <font size="3"> （正确） </font>
  + 5. "全国大学生工业设计大赛是第二等级的吗？"
       + 第二等级(某段)score: 0.7333270311355591
       + 第三等级(某段)score: 0.7263755202293396
       + 第二等级(某段)score: 0.7066514492034912
       + 第三等级(某段)score: 0.7004486322402954 <font size="3"> （正确） </font>
       > topK(3) --- answer: 不知道

<br/>     
<br/>

+ 三个等级比赛目录，按类分段（创新创业 | 设计 | 机器人 | 挑战 | 其它）
  + 1. "全国大学生软件创新大赛"
       + 第二等级(某段)score: 0.6230800151824951 <font size="3"> （正确） </font>
       + 第三等级(某段)score: 0.6214470863342285 <font size="3"> （创新创业类） </font>
       + 第三等级(某段)score: 0.5918700695037842 <font size="3"> （其它类） </font>
  + 2. "全国大学生工业设计大赛"
       + 第三等级(某段)score: 0.6649260520935059 <font size="3"> （正确） </font>
       + 第二等级(某段)score: 0.5833044648170471 <font size="3"> （设计类） </font>
       + 第三等级(某段)score: 0.5831056833267212 <font size="3"> （创新创业类） </font>
  + 3. "蓝桥杯是什么比赛"
       + 第三等级(某段)score: 0.5147182941436768 <font size="3"> （正确） </font>
         > <font size="3">蓝桥杯在其它类段里，由于其它类比赛信息太杂，所以相似度低</font>
       
       + 第三等级(某段)score: 0.5085140466690063 <font size="3"> （机器人类） </font>
       + 第三等级(某段)score: 0.5046647787094116 <font size="3"> （挑战类） </font>
  + 4. "全国大学生工业设计大赛是第二等级的吗？"
       + 第三等级(某段)score: 0.7437910437583923 <font size="3"> （正确） </font>
       + 第二等级(某段)score: 0.7310258150100708 <font size="3"> （设计类） </font>
       > <font size="3">错误问题引导检索</font>

<br/>     
<br/>
<br/>

##### 二、推免规则 Test
 
<br/>

第一次推免规则分太细了，导致询问"蓝桥杯二等奖可以得多少分时？",检索出来的前六七个向量都是匹配推免规则的，没有匹配到比赛目录蓝桥杯。

<br/>

第二次将推免规则按照二级指标点分割段落，询问"某某奖项二等奖可以多少分？"时，如果是其它类的比赛则前几个匹配的都是推免规则向量，分数占比更高

> 将topK(3)调整为topK(5)
> 
> 其它类比赛目录再细分提高相似度

<br/>

1. "全国大学生软件创新大赛"
   + 第三等级(某段)score: 0.6855349540710449 <font size="3"> （正确） </font>
   + 第二等级(某段)score: 0.6038179993629456 <font size="3"> （创新创业类） </font>
   + 第一等级score: 0.5539847612380981

<br/>

2. "全国大学生软件创新大赛可以得多少分？"
   > answer:
   > 
   > 全国大学生软件创新大赛属于第二等级学科竞赛。根据奖项等级，得分如下：
   > 
   >  -第一等奖：总分40分，限1项
   > 
   >  -第二等奖：总分30分，限1项 
   > 
   > 仅限个人项目或集体项目获得国际或国家竞赛二等奖及以上者申报，且同一项竞赛不累计计分，取最高等级计分。
   + 高水平学科竞赛**规则**,score: 0.554253339767456 <font size="3"> （正确） </font>
   + 第二等级(某段)score: 0.554253339767456 <font size="3"> （正确） </font>
   + 学术专长**规则**,score: 0.544765293598175

<br/>

3. "全国大学生软件创新大赛二等奖可以得多少分？"
   > answer:
   > 
   > 全国大学生软件创新大赛属于第二等级学科竞赛。根据规则，第二等级竞赛的二等奖得分为30分。
   + 高水平学科竞赛**规则**,score: 0.5920986533164978 <font size="3"> （正确） </font>
   + 第二等级(某段)score: 0.5550552606582642 <font size="3"> （正确） </font>
   + 学术专长**规则**,score: 0.5170667171478271

<br/>

4. "蓝桥杯一等奖可以得多少分啊？" --(缩小其它类段的长度为三个比赛，相似度显著提高)
   > answer:
   >
   >  蓝桥杯一等奖属于第三等级学科竞赛的第一等奖，得分为30分。

<br/>

 修改前:
 + 高水平学科竞赛**规则**,score: 0.544950008392334 <font size="3"> （正确） </font>
 + 学术专长**规则**,score: 0.4758078455924988
 + 高质量论文**规则**,score: 0.453511118888855
 + 第三等级(某段)score: 0.4044959545135498
 + 第二等级(某段)score: 0.39912331104278564
 + 第三等级(某段)score: 0.3974771499633789
 + 第三等级(某段)score: 0.3927708566188812
 + 第二等级(某段)score: 0.3894224464893341
 + 第一等级score: 0.38796889781951904
 + 第三等级(某段)score: 0.38075727224349976 <font size="3"> （正确） </font>
 
> 匹配其它类段的比赛效果不好，将其它类按每三个比赛分一个段

<br/>

 修改后:
   + 高水平学科竞赛**规则**,score: 0.544950008392334 <font size="3"> （正确） </font>
   + 学术专长**规则**,score: 0.4758078455924988
   + 高质量论文**规则**,score: 0.453511118888855
   + 第三等级(某段)score: 0.4374549984931946 <font size="3"> （正确） </font>

<br/>
   
如果单个比赛作为一段的话:

  "蓝桥杯一等奖可以得多少分啊？"

+ 蓝桥杯, score: 0.5617063641548157
+ 蓝桥杯全国软件和信息技术专业人才大赛, score: 0.5442405939102173

相似度也不是很高，但是比三个比赛一段的 score: 0.4374549984931946 好很多


<br/>     
<br/>
<br/>

#### 细则 Test
  
<br/>

1. "软件创新大赛第五名可以得多少分？"
   > answer:
   > 
   > 1. 全国大学生软件创新大赛属于第二等级学科竞赛。根据规则，第二等级竞赛的第二等奖得分为30分。由于第五名未明确对应奖项等级，但通常低于二等奖，则不满足计分条件。因此，软件创新大赛第五名不得分。
   > 
   > <br/>
   >
   > 2. 全国大学生软件创新大赛属于第二等级学科竞赛。根据规则，第二等级竞赛的第二等奖得分为30分。由于第五名通常对应二等奖或以下奖项，因此软件创新大赛第五名得分为30分。

信息不明确，两次提问出现两个答案: 规则中缺少分一二等奖的细则以及竞赛是团体or个人比赛的说明

<br/>

2. "软件创新大赛二等奖团体内第五名可以得多少分？"
   > answer:
   > 
   >   软件创新大赛属于第二等级学科竞赛。根据规则，第二等级的二等奖得分为30分。但由于是集体项目，主力成员仅认定前两名，而该学生为团队第五名，不属于主力成员认定范围，因此不能获得分数。

<br/>
<br/>

每个比赛添加项目类型(个人/集体)后:

<br/>

1. "软件创新大赛第五名可以得多少分？" (集体项目)
   > answer:
   > 
   > 全国大学生软件创新大赛属于第二等级学科竞赛。根据规则，第二等级竞赛的二等奖得分为30分。因此，软件创新大赛第五名若对应的是二等奖，则得分为30分。但具体名次与奖项等级的对应关系需参考该竞赛的实际奖项设置。若第五名未达到二等奖及以上（即未达到第二等级要求），则不符合计分条件。
     由于无法确定“第五名”是否对应“二等奖”或更高等级，因此不能明确得分。如果第五名未获得二等奖及以上奖项，则不得分；若获得二等奖或以上，则最高得30分。
     综上，若第五名属于二等奖，则得30分；否则不得分。

回答信息冗余不清晰，修改template模板，完善回答信息及注意方向

原先：
```
<query>
Context information is below.

---------------------
<question_answer_context>
---------------------

Given the context information and no prior knowledge, answer the query.

Follow these rules:

1. If the answer is not in the context, just say that you don't know.
2. Avoid statements like "Based on the context..." or "The provided information...".
```

<br/>

修改后：
```
Context information is below.
---------------------
<question_answer_context>
---------------------
Given the context information and no prior knowledge, answer the query strictly follow these rules:
1. Answer with conclusion first, absolutely concise, no redundant words.
2. If the context clearly marks the competition as a **group project**, must take "only the top 2 team members are eligible for scoring" as the first hard rule, never use "if it is a group project".
3. For competition scoring, the two core prerequisites must be stated in order:
    Prerequisite 1 (mandatory): Group project → only top 2 members qualify,
    Prerequisite 2 (mandatory): Only national second prize or above is eligible for scoring
4. If the correspondence between ranking and award level is unclear in the context, directly conclude: **Unable to score**, and supplement the reason: the ranking is not confirmed to correspond to national second prize or above, and the scoring prerequisites are not met.
5. If the answer is not in the context, only reply: I don't know.
6. Never use phrases like "Based on the context" or "The provided information".
7. Answer the question only in Chinese, no English words or sentences are allowed.
```

> answer:
> 
> 20分。
> 
>前提1：全国大学生软件创新大赛为集体项目，仅前两名主力成员可得分。  
前提2：仅获国家级二等奖及以上奖项可得分。  
该赛事属于第二等级竞赛目录，第五名未明确对应奖项等级，但根据常规认定，第五名通常不等于二等奖及以上，因此不符合得分条件。  
**Unable to score**，原因为：排名未确认对应国家级二等奖及以上，且未满足得分前置条件。

<br/>

再次修改，直接用中文了：
```
上下文信息如下。
---------------------
<question_answer_context>
---------------------
结合上下文信息，无任何前置知识，严格按以下规则回答问题：
1. 结论先行，极致简洁，无冗余话，不拆分列点，不出现前提1/前提2类表述。
2. 若上下文明确赛事为集体项目，直接以「仅团队前两名主力成员可计分」作为首要计分规则，禁止用“若为集体项目”等假设性语句。
3. 计分核心要求需融合表述：集体项目仅前两名可计分、仅国家级二等奖及以上奖项可计分，无需单独拆分。
4. 若排名/名称与奖项等级的对应关系未在上下文明确，统一表述为「奖项等级按赛事评定规则核定」，严禁使用常规、通常、一般等主观词汇。
5. 未满足计分条件的，直接结论为「得0分」，理由紧密融合核心要求+赛事评定规则，逻辑连贯。
6. 全程仅用纯中文作答，无任何英文单词、句式。
7. 若上下文无相关作答信息，仅回复：不知道。
8. 严禁使用“根据上下文、依据提供的信息”等表述。
```

> answer:
> 
> 软件创新大赛为第三等级学科竞赛，仅团队前两名主力成员可计分，且需获国家级二等奖及以上奖项。第五名不符合主力成员认定条件，得0分。

我问的是 <font size="3">软件创新大赛第五名可以得多少分？</font> ，这个第五名是比赛第五名，而不是团体内成员第五名。


<br/>

不断修改，发现大模型可以自动辨别赛事类型（个人/集体），所以删去向量中自己加的类别，最终template为：
```
上下文信息如下。
---------------------
<question_answer_context>
---------------------
结合上下文信息，无任何前置知识，严格按以下规则回答问题：
1.【明确奖项+等级计分铁则】只要明确「赛事+学科等级+奖项+固定分值」，结论**必须严格等于该固定分值**，理由仅固定格式：XX赛事属于X等级学科竞赛，其X等奖对应计X分。严禁结论与理由分值矛盾，严禁提其他等级/分值，严禁自创任何分值。
2. 结论先行，但是必须要推理完毕后，再说出回答，极致简洁，无冗余，无引导词，结论后直接句号接理由，无任何多余表述。
3. 严格界定：【赛事总排名】=赛事整体排名（如第三名/第二名），【团队内排名】=团队内部成员位次（如团内第二名），二者完全独立互斥；集体项目仅团内前两名成员有计分资格，该资格仅判定成员是否能计分，与赛事总排名的奖项等级无关。
4. 集体项目直接执行「仅团内前两名有计分资格」，无任何假设性表述。
5. 只要团内第三名及以后，结论得0分，理由：集体项目仅团队内前两名计分，该团队内排名无计分资格。
6. 只要提问含「赛事总排名」（无论第几名），且团内排名有效，只要未明确标注国家级一等奖/二等奖，结论强制唯一为暂无法确定得分，无任何例外！理由固定格式：该名次为赛事总排名，未明确对应奖项等级，奖项等级需按赛事评定规则核定。
7. 全程严禁将赛事数字名次与国家级奖项/学科等级做任何映射、推定、对应，哪怕同数字也绝对禁止。
8. 一等奖、二等奖 与 排名/名次/第几名 无任何关联，禁止映射。
9. 排名/名次/位次 与 任何等级(一二等级) 无任何关联，禁止映射。
10. 严禁任何场景下主观推定奖项/等级/分数，未明确标注即视为无，仅提按赛事规则核定。
11. 全程纯中文作答，无主观词汇；无信息仅回复：不知道；严禁用「根据上下文」等表述。
12. 计分需要严格按照备注中的规则，如限项，上限分数及特殊要求，如果计分涉及到备注中规则，则理由必须说明。
```

> answer:
>
> 暂无法确定得分。该名次为赛事总排名，未明确对应奖项等级，奖项等级需按赛事评定规则核定。

<br/>
<br/>
<br/>

#### Last：

1. 机械创新设计大赛第二名有多少分？
   > answer:
   > 
   >  暂无法确定得分。该名次为赛事总排名，未明确对应奖项等级，奖项等级需按赛事评定规则核定。

<br/>

2. 机械创新设计大赛团体内第三名有多少分？
   > answer:
   > 
   > 0分。集体项目仅团队内前两名计分，该团队内排名无计分资格。

<br/>

3. 机械创新设计大赛第三名团体内第三名有多少分？
   > answer:
   > 
   >  0分。集体项目仅团队内前两名计分，该团队内排名无计分资格。

<br/>

4. 机械创新设计大赛第三名团体内第二名有多少分？
   > answer:
   >
   >  暂无法确定得分。该名次为赛事总排名，未明确对应奖项等级，奖项等级需按赛事评定规则核定。

<br/>

5. 机械创新设计大赛二等奖团体内第三名有多少分？ 
   > answer:
   > 
   > 0分。集体项目仅团队内前两名计分，该团队内排名无计分资格。

<br/>

6. 机械创新设计大赛二等奖团体内第二名有多少分？
   > answer:
   > 
   > 30分。全国大学生机械创新设计大赛属于第二等级学科竞赛，其二等奖对应计30分。

<br/>

7. 全国大学生数学竞赛第一名有多少分?  ----个人项目
   > answer:
   > 
   >  暂无法确定得分。该名次为赛事总排名，未明确对应奖项等级，奖项等级需按赛事评定规则核定。

<br/>

8. 全国大学生数学竞赛一等奖有多少分?  ----个人项目
   > answer:
   > 
   > 全国大学生数学竞赛一等奖计40分。全国大学生数学竞赛属于第二等级学科竞赛，其一等奖对应计40分。

<br/>

9. 机械创新设计大赛是个人项目还是集体项目？
   > answer:
   > 
   >  集体项目。全国大学生机械创新设计大赛属于第二等级学科竞赛目录中的赛事，其项目性质为集体项目。

<br/>

10. 我得了一个机械创新设计大赛二等奖和全国大学生数学竞赛一等奖，有多少分？

+ 第一次未查找到全国大学生数学竞赛，将topK(5)改为topK(7)

   > answer:
   > 
   >  40分。全国大学生数学竞赛属于第二等级学科竞赛，其一等奖对应计40分；全国大学生机械创新设计大赛属于第二等级学科竞赛，其二等奖对应计30分。根据代表作制不累计计分，取最高等级计分，因此计40分。